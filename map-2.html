<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <title>map</title>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        *,
        *::before,
        *::after {
            box-sizing: border-box;
        }

        body {
            font-family: 'Gilroy', sans-serif !important;
        }

        #map {
            height: 500px;
            width: 100vw;
            margin: 0;
            padding: 0;
        }

        body,
        html {
            height: 100%;
            margin: 0;
        }

        .custom-popup .leaflet-popup-content-wrapper {
            background: #8FC15A;
            color: white;
            box-shadow: none;
        }

        .custom-popup .leaflet-popup-tip {
            background: #8FC15A;
            box-shadow: none;
            margin: -12px auto 0;
        }

        .leaflet-fade-anim .leaflet-map-pane .leaflet-popup {
            bottom: 7px !important;
        }

        .leaflet-container a.leaflet-popup-close-button {
            display: none;
        }

        .leaflet-popup-content {
            font-family: 'Gilroy', sans-serif !important;
            font-size: 18px;
            font-weight: 500;
            margin: 7px 20px;
        }

        .map-color-filter {
            filter: url(#land-water-filter);
        }

        .leaflet-marker-icon div {
            background: rgba(164, 236, 88, 0.40);
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .leaflet-marker-icon:hover div,
        .leaflet-marker-icon.active div {
            transform: scale(1.45) !important;
        }

        .leaflet-marker-icon div span {
            transition: all 0.3s ease;
        }

        .leaflet-marker-icon.active div span,
        .leaflet-marker-icon:hover div span {
            transform: scale(1.2) !important;
        }

        .location-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .c-location.active {
            font-weight: bold;
            text-decoration: underline;
        }

        .leaflet-bottom {
            display: none;
        }
    </style>
</head>

<body>
    <svg width="0" height="0" style="position:absolute">
        <filter id="land-water-filter">
            <feColorMatrix type="matrix" values="
                1 0 0 0 0.11
                0 1 0 0 0.15
                0 0 1 0 0.07
                0 0 0 1 0
            " />
        </filter>
    </svg>
    <div id="map"></div>
    <div class="location-list">
        <a href="#" class="c-location" data-lat="50.4501" data-lng="30.5234">
            <strong class="location-title">Kyiv, Ukraine</strong>
            <span>Total area of ​​plantations - 43 hectares. The number of planted trees - over 640k</span>
        </a>
        <a href="#" class="c-location" data-lat="48.8566" data-lng="2.3522">
            <strong class="location-title">Paris, France</strong>
            <span>Total area of ​​plantations - 12 hectares. The number of planted trees - over 180k</span>
        </a>
        <a href="#" class="c-location" data-lat="52.5200" data-lng="13.4050">
            <strong class="location-title">Berlin, Germany</strong>
            <span>Total area of ​​plantations - 8 hectares. The number of planted trees - over 120k</span>
        </a>
        <a href="#" class="c-location" data-lat="41.9028" data-lng="12.4964">
            <strong class="location-title">Rome, Italy</strong>
            <span>Total area of ​​plantations - 15 hectares. The number of planted trees - over 210k</span>
        </a>
        <a href="#" class="c-location" data-lat="51.5074" data-lng="-0.1278">
            <strong class="location-title">London, United Kingdom</strong>
            <span>Total area of ​​plantations - 10 hectares. The number of planted trees - over 150k</span>
        </a>
        <a href="#" class="c-location" data-lat="40.4168" data-lng="-3.7038">
            <strong class="location-title">Madrid, Spain</strong>
            <span>Total area of ​​plantations - 7 hectares. The number of planted trees - over 100k</span>
        </a>
        <a href="#" class="c-location" data-lat="52.2297" data-lng="21.0122">
            <strong class="location-title">Warsaw, Poland</strong>
            <span>Total area of ​​plantations - 9 hectares. The number of planted trees - over 130k</span>
        </a>
    </div>
    <script>
        var mapFilterClass = 'map-color-filter';
        var map = L.map('map', {
            center: [48, 15],
            zoom: 3,
            minZoom: 2,
            maxZoom: 20
        });
        var positron = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://carto.com/">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);
        positron.on('load', function () {
            var container = positron.getContainer();
            if (container) container.classList.add(mapFilterClass);
        });
        var container = positron.getContainer();
        if (container) container.classList.add(mapFilterClass);

        // Замість ручного масиву locations:
        var locationLinks = document.querySelectorAll('.c-location');
        var locations = Array.from(locationLinks).map(function (el) {
            var titleEl = el.querySelector('.location-title');
            var title = titleEl ? titleEl.textContent.trim() : el.textContent.trim();
            return [
                parseFloat(el.getAttribute('data-lat')),
                parseFloat(el.getAttribute('data-lng')),
                title
            ];
        });

        var markers = [];

        locations.forEach(function (loc, index) {
            var icon = L.divIcon({
                className: '',
                iconSize: [22, 22],
                iconAnchor: [11, 11],
                html: '<div style="width:22px;height:22px;display:flex;align-items:center;justify-content:center;position:relative;">' +
                    '<span style="display:block;width:11px;height:11px;background:#8FC15A;border-radius:50%;border:2px solid #fff;"></span>' +
                    '</div>'
            });

            var marker = L.marker([loc[0], loc[1]], { icon: icon })
                .addTo(map)
                .bindPopup(loc[2], { className: 'custom-popup' });

            function setActiveMarkerAndLocation() {
                // Додаємо active тільки при кліку, тому тут нічого не робимо
            }

            // --- Клік по маркеру: додаємо active і фіксуємо popup ---
            marker.on('click', function (e) {
                markers.forEach(m => m.getElement()?.classList.remove('active'));
                locationLinks.forEach(el => el.classList.remove('active'));
                var markerEl = marker.getElement();
                if (markerEl) markerEl.classList.add('active');
                if (locationLinks[index]) locationLinks[index].classList.add('active');
                map.setView(marker.getLatLng(), map.getZoom(), { animate: true });
                marker.openPopup();
            });

            // --- Наведення: тільки показуємо popup, але не додаємо active ---
            marker.on('mouseover', function () {
                marker.openPopup();
            });
            marker.on('mouseout', function () {
                // Закриваємо popup лише якщо він не був відкритий кліком (тобто маркер не active)
                var markerEl = marker.getElement();
                if (markerEl && markerEl.classList.contains('active')) return;
                marker.closePopup();
            });

            markers.push(marker);
        });

        locationLinks.forEach(function (el, i) {
            el.addEventListener('click', function (e) {
                e.preventDefault();
                locationLinks.forEach(link => link.classList.remove('active'));
                markers.forEach(m => m.getElement()?.classList.remove('active'));

                el.classList.add('active');
                // Отримуємо координати з data-атрибутів
                var lat = parseFloat(el.getAttribute('data-lat'));
                var lng = parseFloat(el.getAttribute('data-lng'));
                var marker = markers[i];
                var latlng = marker && marker.getLatLng();
                // Якщо координати є, фокусуємось по ним, інакше fallback на маркер
                if (!isNaN(lat) && !isNaN(lng)) {
                    map.setView([lat, lng], map.getZoom(), { animate: true });
                    map.once('moveend', () => {
                        marker.openPopup();
                        marker.getElement()?.classList.add('active');
                    });
                } else if (latlng) {
                    map.setView(latlng, map.getZoom(), { animate: true });
                    map.once('moveend', () => {
                        marker.openPopup();
                        marker.getElement()?.classList.add('active');
                    });
                }
            });
        });

        map.on('click', function () {
            markers.forEach(m => m.getElement()?.classList.remove('active'));
            locationLinks.forEach(el => el.classList.remove('active'));
        });

        // Після створення markers і locationLinks
        function activateLocationByCountry(userCountry) {
            // Пошук індексу локації за країною
            let idx = -1;
            if (userCountry) {
                idx = locations.findIndex(loc => loc[2].toLowerCase().includes(userCountry.toLowerCase()));
            }
            // Якщо не знайдено, шукаємо найближчу локацію за координатами
            if (idx === -1 && window.navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (pos) {
                    let minDist = Infinity, minIdx = 0;
                    locations.forEach(function (loc, i) {
                        let d = Math.sqrt(
                            Math.pow(loc[0] - pos.coords.latitude, 2) +
                            Math.pow(loc[1] - pos.coords.longitude, 2)
                        );
                        if (d < minDist) {
                            minDist = d;
                            minIdx = i;
                        }
                    });
                    activateByIndex(minIdx);
                }, function () {
                    // Якщо відмовлено у геолокації — активуємо першу
                    activateByIndex(0);
                });
            } else if (idx !== -1) {
                activateByIndex(idx);
            } else {
                activateByIndex(0);
            }
        }

        function activateByIndex(i) {
            locationLinks.forEach(link => link.classList.remove('active'));
            markers.forEach(m => m.getElement()?.classList.remove('active'));
            locationLinks[i].classList.add('active');
            let marker = markers[i];
            marker.getElement()?.classList.add('active');
            map.setView(marker.getLatLng(), map.getZoom(), { animate: true });
            marker.openPopup();
        }

        // Визначаємо країну користувача через ip-api.com
        fetch('https://ip-api.io/json')
            .then(r => r.json())
            .then(data => {
                activateLocationByCountry(data.country || '');
            })
            .catch(() => {
                activateLocationByCountry('');
            });
    </script>
</body>

</html>